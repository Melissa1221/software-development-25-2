# Ejercicio 2.3: Mutator con local_file

## Implementación

Se creó el módulo `iac_patterns/mutators.py` con funciones mutadoras reutilizables para el patrón Prototype. La función principal es `convert_null_to_local_file()` que transforma recursos `null_resource` en `local_file`.

```python
def convert_null_to_local_file(resource_dict: Dict[str, Any],
                                filename: str = "output.txt",
                                content: str = "Generated by IaC") -> None:
    """
    Convierte un recurso null_resource a local_file.

    Esta función mutadora extrae los triggers del null_resource y los convierte
    en un recurso local_file con nombre de archivo y contenido personalizables.
    """
    # Buscar null_resource en la estructura
    for resource_block in resources:
        if "null_resource" in resource_block:
            # Extraer información del null_resource original
            null_res = resource_block["null_resource"][0]
            original_name = list(null_res.keys())[0]

            # Crear nuevo recurso local_file
            new_name = f"{original_name}_file"
            local_file_resource = {
                new_name: [{
                    "filename": filename,
                    "content": content,
                    "file_permission": "0644"
                }]
            }

            # Reemplazar null_resource con local_file
            del resource_block["null_resource"]
            resource_block["local_file"] = [local_file_resource]
```

## Funciones adicionales

El módulo incluye dos funciones auxiliares además de la conversión principal. La función `rename_resource()` permite cambiar el nombre de un recurso mientras mantiene su tipo original. La función `add_trigger()` agrega nuevos triggers a recursos null_resource sin eliminar los existentes.

## Validación

El test valida cuatro escenarios diferentes. La conversión de null_resource a local_file transforma correctamente el tipo de recurso. El renombrado cambia nombres mientras preserva toda la estructura del recurso.

La función de agregar triggers añade nuevos valores sin eliminar los triggers previos. La inmutabilidad del prototipo se verifica comprobando que el original permanece sin cambios después de las clonaciones.

## Resultados

### Test 1: Conversión null_resource -> local_file

**Antes (null_resource):**
```json
{
  "resource": [{
    "null_resource": [{
      "app_server": [{
        "triggers": {
          "factory_uuid": "e276fccc-9418-43c0-8e0b-96624a361a09",
          "timestamp": "2025-10-30T16:04:46.362038"
        }
      }]
    }]
  }]
}
```

**Después (local_file):**
```json
{
  "resource": [{
    "local_file": [{
      "app_server_file": [{
        "filename": "app_config.txt",
        "content": "Application configuration",
        "file_permission": "0644"
      }]
    }]
  }]
}
```

### Todos los tests

```
[OK] Validación exitosa: null_resource -> local_file
[OK] Validación exitosa: renombrado correcto
[OK] Validación exitosa: trigger agregado correctamente
[OK] Validación exitosa: inmutabilidad preservada

==================================================
[OK] TODOS LOS TESTS PASARON CORRECTAMENTE
==================================================
```

## Utilidad

Las funciones mutadoras permiten transformar recursos Terraform de forma declarativa y reutilizable. El patrón Prototype garantiza que las transformaciones no afecten al recurso original, permitiendo generar múltiples variaciones a partir de una plantilla base. Esto es especialmente útil para migrar recursos de un tipo a otro (como de recursos de prueba `null_resource` a recursos reales `local_file`, `aws_instance`, etc.) sin reescribir código.
